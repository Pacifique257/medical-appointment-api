<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Create Appointment</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding-top: 80px;
        }
        .form-container {
            max-width: 550px;
            width: 100%;
            background-color: #ffffff;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 0 15px rgba(0,0,0,0.1);
            border: 2px solid gold;
        }
        h2 {
            color: #6c757d;
        }
        label {
            color: #6c757d;
        }
        .form-control, .form-select {
            border: 1px solid #ced4da;
        }
        .btn-primary {
            background-color: gold;
            border: none;
            color: #343a40;
            font-weight: bold;
        }
        .btn-primary:hover {
            background-color: #d4af37;
            color: #212529;
        }
        a {
            color: gold;
        }
        a:hover {
            color: #d4af37;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
<div class="form-container">
    <h2 class="text-center mb-4">Create Appointment</h2>

    <div th:if="${error}" class="alert alert-danger" th:text="${error}"></div>

    <form th:action="@{/api/appointments/create(token=${token})}" method="post" th:object="${appointmentDTO}">
        <input type="hidden" th:field="*{patientId}" id="patientId">

        <div class="mb-3">
            <label for="specialtyId" class="form-label">Specialty</label>
            <select id="specialty-select" class="form-select" required>
                <option value="">Select a Specialty</option>
                <option th:each="specialty: ${specialties}" th:value="${specialty.id}" th:text="${specialty.name}"></option>
            </select>
        </div>

        <div class="mb-3 hidden" id="doctor-select-container">
            <label for="doctorId" class="form-label">Doctor</label>
            <select id="doctorId" class="form-select" th:field="*{doctorId}" required>
                <option value="">Select a Doctor</option>
            </select>
        </div>

        <div class="mb-3 hidden" id="date-container">
            <label for="appointmentDate" class="form-label">Date</label>
            <input type="date" id="appointmentDate" class="form-control" th:field="*{appointmentDate}" required>
        </div>

        <div class="mb-3 hidden" id="time-slot-container">
            <label for="timeSlot" class="form-label">Time Slot</label>
            <select id="timeSlot" class="form-select" th:field="*{timeSlot}" required>
                <option value="">Select a Time Slot</option>
            </select>
            <input type="hidden" id="availabilityId" th:field="*{availabilityId}">
        </div>

        <div class="mb-3 hidden" id="consultationFee-container">
            <label for="consultationFee" class="form-label">Consultation Fee</label>
            <input type="number" id="consultationFee" class="form-control" th:field="*{consultationFee}" readonly>
        </div>

        <div class="mb-3">
            <label for="reason" class="form-label">Reason</label>
            <textarea id="reason" class="form-control" th:field="*{reason}" rows="4" required></textarea>
        </div>

        <button type="submit" class="btn btn-primary w-100">Create Appointment</button>
    </form>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    document.getElementById('specialty-select').addEventListener('change', function() {
        const specialtyId = this.value;
        if (specialtyId) {
            fetch('/api/appointments/doctors?specialtyId=' + specialtyId)
                .then(response => response.json())
                .then(doctors => {
                    const doctorSelect = document.getElementById('doctorId');
                    doctorSelect.innerHTML = '<option value="">Select a Doctor</option>';
                    doctors.forEach(doctor => {
                        const option = document.createElement('option');
                        option.value = doctor.id;
                        option.text = doctor.lastName + ' ' + doctor.firstName;
                        doctorSelect.appendChild(option);
                    });
                    document.getElementById('doctor-select-container').classList.remove('hidden');
                })
                .catch(error => console.error('Error loading doctors:', error));
        } else {
            resetFields();
        }
    });

    document.getElementById('doctorId').addEventListener('change', function() {
        const doctorId = this.value;
        if (doctorId) {
            fetch('/api/appointments/dates?doctorId=' + doctorId)
                .then(response => response.json())
                .then(dates => {
                    const dateInput = document.getElementById('appointmentDate');
                    dateInput.value = '';
                    document.getElementById('date-container').classList.remove('hidden');
                    dateInput.addEventListener('change', function() {
                        loadTimeSlots(doctorId, this.value);
                    }, { once: true });
                })
                .catch(error => console.error('Error loading dates:', error));
            fetch('/api/appointments/fee?doctorId=' + doctorId)
                .then(response => response.json())
                .then(fee => {
                    const feeInput = document.getElementById('consultationFee');
                    feeInput.value = fee;
                    document.getElementById('consultationFee-container').classList.remove('hidden');
                })
                .catch(error => console.error('Error loading fee:', error));
        } else {
            resetFields();
        }
    });

    function loadTimeSlots(doctorId, date) {
        if (date) {
            fetch('/api/appointments/slots?doctorId=' + doctorId + '&date=' + date)
                .then(response => response.json())
                .then(slots => {
                    const slotSelect = document.getElementById('timeSlot');
                    slotSelect.innerHTML = '<option value="">Select a Time Slot</option>';
                    slots.forEach(slot => {
                        const option = document.createElement('option');
                        option.value = slot;
                        // Récupérer dayOfWeek pour cette date et slot
                        fetch('/api/appointments/availability?doctorId=' + doctorId + '&date=' + date + '&timeSlot=' + encodeURIComponent(slot))
                            .then(response => response.json())
                            .then(availability => {
                                option.text = availability.dayOfWeek + ', ' + slot;
                            })
                            .catch(error => {
                                option.text = slot;
                            })
                            .finally(() => {
                                slotSelect.appendChild(option);
                            });
                    });
                    document.getElementById('time-slot-container').classList.remove('hidden');
                    slotSelect.addEventListener('change', function() {
                        fetch('/api/appointments/availability?doctorId=' + doctorId + '&date=' + date + '&timeSlot=' + encodeURIComponent(this.value))
                            .then(response => {
                                if (!response.ok) throw new Error('Availability not found or already taken');
                                return response.json();
                            })
                            .then(availability => {
                                document.getElementById('availabilityId').value = availability.id;
                                console.log('Availability ID set to: ' + availability.id);
                            })
                            .catch(error => {
                                alert('Error: ' + error.message);
                                slotSelect.value = '';
                                document.getElementById('availabilityId').value = '';
                            });
                    }, { once: true });
                })
                .catch(error => console.error('Error loading slots:', error));
        } else {
            document.getElementById('time-slot-container').classList.add('hidden');
        }
    }

    function resetFields() {
        document.getElementById('doctor-select-container').classList.add('hidden');
        document.getElementById('date-container').classList.add('hidden');
        document.getElementById('time-slot-container').classList.add('hidden');
        document.getElementById('consultationFee-container').classList.add('hidden');
        document.getElementById('doctorId').innerHTML = '<option value="">Select a Doctor</option>';
        document.getElementById('timeSlot').innerHTML = '<option value="">Select a Time Slot</option>';
        document.getElementById('appointmentDate').value = '';
        document.getElementById('consultationFee').value = '';
        document.getElementById('availabilityId').value = '';
    }
</script>
</body>
</html>