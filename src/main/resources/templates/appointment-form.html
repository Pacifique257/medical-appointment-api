<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Create Appointment</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding-top: 80px;
        }
        .form-container {
            max-width: 550px;
            width: 100%;
            background-color: #ffffff;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 0 15px rgba(0,0,0,0.1);
            border: 2px solid gold;
        }
        h2 {
            color: #6c757d;
        }
        label {
            color: #6c757d;
        }
        .form-control, .form-select {
            border: 1px solid #ced4da;
        }
        .btn-primary {
            background-color: gold;
            border: none;
            color: #343a40;
            font-weight: bold;
        }
        .btn-primary:hover {
            background-color: #d4af37;
            color: #212529;
        }
        a {
            color: gold;
        }
        a:hover {
            color: #d4af37;
        }
        .hidden {
            display: none;
        }
        .alert {
            margin-top: 10px;
        }
    </style>
</head>
<body>
<div class="form-container">
    <h2 class="text-center mb-4">Create Appointment</h2>

    <div th:if="${error}" class="alert alert-danger" th:text="${error}"></div>
    <div id="ajax-error" class="alert alert-danger hidden"></div>

    <form id="appointment-form" th:action="@{/api/appointments/create(token=${token})}" method="post" th:object="${appointmentDTO}">
        <input type="hidden" th:field="*{patientId}" id="patientId">

        <div class="mb-3">
            <label for="specialtyId" class="form-label">Specialty</label>
            <select id="specialty-select" class="form-select" required>
                <option value="">Select a Specialty</option>
                <option th:each="specialty : ${specialties}" th:value="${specialty.id}" th:text="${specialty.name}"></option>
            </select>
        </div>

        <div class="mb-3 hidden" id="doctor-select-container">
            <label for="doctorId" class="form-label">Doctor</label>
            <select id="doctorId" class="form-select" th:field="*{doctorId}" required>
                <option value="">Select a Doctor</option>
            </select>
        </div>

        <div class="mb-3 hidden" id="date-container">
            <label for="appointmentDate" class="form-label">Date</label>
            <input type="date" id="appointmentDate" class="form-control" th:field="*{appointmentDate}" required>
        </div>

        <div class="mb-3 hidden" id="time-slot-container">
            <label for="timeSlot" class="form-label">Time Slot</label>
            <select id="timeSlot" class="form-select" th:field="*{timeSlot}" required>
                <option value="">Select a Time Slot</option>
            </select>
            <input type="hidden" id="availabilityId" th:field="*{availabilityId}" name="availabilityId">
        </div>

        <div class="mb-3 hidden" id="consultationFee-container">
            <label for="consultationFee" class="form-label">Consultation Fee</label>
            <input type="number" id="consultationFee" class="form-control" th:field="*{consultationFee}" readonly>
        </div>

        <div class="mb-3">
            <label for="reason" class="form-label">Reason</label>
            <textarea id="reason" class="form-control" th:field="*{reason}" rows="4" required></textarea>
        </div>

        <button type="submit" class="btn btn-primary w-100">Book Appointment</button>
    </form>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script th:inline="javascript">
    // Initialize JWT token from Thymeleaf context
    const jwtToken = /*[[${token}]]*/ null;
    console.log('JWT Token:', jwtToken);

    // Show error message in the form
    function showAjaxError(message) {
        const errorDiv = document.getElementById('ajax-error');
        errorDiv.textContent = message;
        errorDiv.classList.remove('hidden');
    }

    // Hide error message
    function hideAjaxError() {
        const errorDiv = document.getElementById('ajax-error');
        errorDiv.classList.add('hidden');
    }

    // Handle specialty selection
    document.getElementById('specialty-select').addEventListener('change', function() {
        const specialtyId = this.value;
        hideAjaxError();
        if (specialtyId) {
            console.log('Fetching doctors for specialtyId:', specialtyId);
            fetch(`/api/appointments/doctors?specialtyId=${specialtyId}&token=${jwtToken}`)
                .then(response => {
                    if (!response.ok) throw new Error(`Failed to fetch doctors: ${response.status}`);
                    return response.json();
                })
                .then(doctors => {
                    console.log('Doctors received:', doctors);
                    const doctorSelect = document.getElementById('doctorId');
                    doctorSelect.innerHTML = '<option value="">Select a Doctor</option>';
                    doctors.forEach(doctor => {
                        const option = document.createElement('option');
                        option.value = doctor.id;
                        option.text = doctor.lastName + ' ' + doctor.firstName;
                        doctorSelect.appendChild(option);
                    });
                    document.getElementById('doctor-select-container').classList.remove('hidden');
                })
                .catch(error => {
                    console.error('Error loading doctors:', error);
                    showAjaxError('Unable to load doctors. Please try again.');
                });
        } else {
            resetFields();
        }
    });

    // Handle doctor selection
    document.getElementById('doctorId').addEventListener('change', function() {
        const doctorId = this.value;
        hideAjaxError();
        if (doctorId) {
            console.log('Fetching dates for doctorId:', doctorId);
            fetch(`/api/appointments/dates?doctorId=${doctorId}&token=${jwtToken}`)
                .then(response => {
                    if (!response.ok) throw new Error(`Failed to fetch dates: ${response.status}`);
                    return response.json();
                })
                .then(dates => {
                    console.log('Dates received:', dates);
                    const dateInput = document.getElementById('appointmentDate');
                    dateInput.value = '';
                    document.getElementById('date-container').classList.remove('hidden');
                    dateInput.addEventListener('change', function() {
                        loadTimeSlots(doctorId, this.value);
                    });
                })
                .catch(error => {
                    console.error('Error loading dates:', error);
                    showAjaxError('Unable to load available dates. Please try again.');
                });

            console.log('Fetching fee for doctorId:', doctorId);
            fetch(`/api/appointments/fee?doctorId=${doctorId}&token=${jwtToken}`)
                .then(response => {
                    if (!response.ok) throw new Error(`Failed to fetch fee: ${response.status}`);
                    return response.json();
                })
                .then(fee => {
                    console.log('Fee received:', fee);
                    const feeInput = document.getElementById('consultationFee');
                    feeInput.value = fee;
                    document.getElementById('consultationFee-container').classList.remove('hidden');
                })
                .catch(error => {
                    console.error('Error loading fee:', error);
                    showAjaxError('Unable to load consultation fee. Please try again.');
                });
        } else {
            resetFields();
        }
    });

    // Load time slots for selected date
    function loadTimeSlots(doctorId, date) {
        hideAjaxError();
        if (date) {
            console.log('Fetching slots for doctorId:', doctorId, 'date:', date);
            fetch(`/api/appointments/slots?doctorId=${doctorId}&date=${date}&token=${jwtToken}`)
                .then(response => {
                    if (!response.ok) throw new Error(`Failed to fetch slots: ${response.status}`);
                    return response.json();
                })
                .then(slots => {
                    console.log('Slots received:', slots);
                    const slotSelect = document.getElementById('timeSlot');
                    slotSelect.innerHTML = '<option value="">Select a Time Slot</option>';
                    slots.forEach(slot => {
                        const option = document.createElement('option');
                        option.value = slot;
                        fetch(`/api/appointments/availability?doctorId=${doctorId}&date=${date}&timeSlot=${encodeURIComponent(slot)}&token=${jwtToken}`)
                            .then(response => {
                                if (!response.ok) throw new Error(`Failed to fetch availability: ${response.status}`);
                                return response.json();
                            })
                            .then(availability => {
                                option.text = availability.dayOfWeek + ', ' + slot;
                            })
                            .catch(error => {
                                option.text = slot;
                                console.error('Error fetching availability for slot:', slot, error);
                            })
                            .finally(() => {
                                slotSelect.appendChild(option);
                            });
                    });
                    document.getElementById('time-slot-container').classList.remove('hidden');
                    slotSelect.addEventListener('change', function() {
                        hideAjaxError();
                        console.log('Fetching availability for slot:', this.value);
                        fetch(`/api/appointments/availability?doctorId=${doctorId}&date=${date}&timeSlot=${encodeURIComponent(this.value)}&token=${jwtToken}`)
                            .then(response => {
                                if (!response.ok) {
                                    let errorMsg = `Failed to fetch availability: ${response.status}`;
                                    if (response.status === 403) {
                                        errorMsg = 'Access denied. Please ensure you have permission to select this time slot.';
                                    } else if (response.status === 404) {
                                        errorMsg = 'This time slot is not available or already taken.';
                                    }
                                    throw new Error(errorMsg);
                                }
                                return response.json();
                            })
                            .then(availability => {
                                document.getElementById('availabilityId').value = availability.id;
                                console.log('DEBUG: Availability ID set to:', availability.id);
                            })
                            .catch(error => {
                                showAjaxError(error.message);
                                slotSelect.value = '';
                                document.getElementById('availabilityId').value = '';
                                console.error('Error setting availability:', error);
                            });
                    });
                })
                .catch(error => {
                    console.error('Error loading slots:', error);
                    showAjaxError('Unable to load time slots. Please try again.');
                });
        } else {
            document.getElementById('time-slot-container').classList.add('hidden');
        }
    }

    // Reset form fields
    function resetFields() {
        hideAjaxError();
        document.getElementById('doctor-select-container').classList.add('hidden');
        document.getElementById('date-container').classList.add('hidden');
        document.getElementById('time-slot-container').classList.add('hidden');
        document.getElementById('consultationFee-container').classList.add('hidden');
        document.getElementById('doctorId').innerHTML = '<option value="">Select a Doctor</option>';
        document.getElementById('timeSlot').innerHTML = '<option value="">Select a Time Slot</option>';
        document.getElementById('appointmentDate').value = '';
        document.getElementById('consultationFee').value = '';
        document.getElementById('availabilityId').value = '';
    }

    // Validate form before submission
    document.getElementById('appointment-form').addEventListener('submit', function(event) {
        const availabilityId = document.getElementById('availabilityId').value;
        if (!availabilityId) {
            event.preventDefault();
            showAjaxError('Please select a time slot before submitting.');
        }
    });
</script>
</body>
</html>