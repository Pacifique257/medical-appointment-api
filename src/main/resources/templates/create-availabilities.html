<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Create Availability</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        .navbar {
            background-color: #6c757d;
        }
        .navbar .nav-link, .navbar-brand {
            color: gold !important;
        }
        .container {
            max-width: 800px;
        }
        .form-label {
            color: #6c757d;
            font-weight: bold;
        }
        .btn-primary {
            background-color: #6c757d;
            border-color: #6c757d;
        }
        .btn-primary:hover {
            background-color: gold;
            border-color: gold;
            color: #6c757d;
        }
        .btn-danger {
            background-color: #dc3545;
            border-color: #dc3545;
        }
        .btn-danger:hover {
            background-color: #c82333;
            border-color: #c82333;
        }
        .slot-container {
            margin-bottom: 15px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #ffffff;
        }
        .text-gold {
            color: gold;
        }
        footer {
            background-color: #6c757d;
            color: gold;
            padding: 20px 0;
            text-align: center;
            margin-top: auto;
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg">
        <div class="container-fluid">
            <a class="navbar-brand" th:text="'Dr. ' + ${user.firstName} + ' ' + ${user.lastName}"></a>
            <div class="navbar-nav">
                <a class="nav-link" th:href="@{/doctor/availability(token=${token})}">List of Availabilities</a>
                <a class="nav-link" th:href="@{/doctor/availability/new(token=${token})}">Create Availability</a>
                <a class="nav-link text-danger" th:href="@{/logout}">Logout</a>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container mt-4">
        <h2 class="text-gold text-center">Create New Availability</h2>
        <div th:if="${error}" class="alert alert-danger" th:text="${error}"></div>
        <div th:if="${success}" class="alert alert-success" th:text="${success}"></div>

        <form th:action="@{/doctor/availability/new(token=${token})}" method="post" id="availabilityForm" onsubmit="logSubmit()">
            <input type="hidden" th:value="${token}" name="token"/>
            <div class="mb-3">
                <label for="date" class="form-label">Date</label>
                <input type="date" class="form-control" id="date" name="date" th:value="${#dates.format(#dates.createNow(), 'yyyy-MM-dd')}" required>
            </div>
            <div class="mb-3">
                <label for="dayOfWeek" class="form-label">Day of Week</label>
                <input type="text" class="form-control" id="dayOfWeek" name="dayOfWeek" readonly>
            </div>
            <div id="slots">
                <div class="slot-container" id="slot-1">
                    <div class="row">
                        <div class="col-md-5">
                            <label for="startTime-1" class="form-label">Start Time</label>
                            <input type="time" class="form-control" id="startTime-1" name="startTimes" required>
                        </div>
                        <div class="col-md-5">
                            <label for="endTime-1" class="form-label">End Time</label>
                            <input type="time" class="form-control" id="endTime-1" name="endTimes" required>
                        </div>
                        <div class="col-md-2 d-flex align-items-end">
                            <button type="button" class="btn btn-danger w-100" onclick="removeSlot(1)" id="remove-1" style="display: none;">Remove</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="mb-3">
                <button type="button" class="btn btn-primary" onclick="addSlot()">Add Another Slot</button>
            </div>
            <div class="mb-3 text-center">
                <button type="submit" class="btn btn-primary">Create</button>
            </div>
        </form>
    </div>

    <!-- Footer -->
    <footer>
        <div class="container">
            <span>Â© 2025 Doctor Portal. All rights reserved.</span>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let slotCount = 1;

        // Set Day of Week based on Date
        function updateDayOfWeek() {
            const dateInput = document.getElementById('date').value;
            console.log('Updating dayOfWeek for date: ' + dateInput);
            if (dateInput) {
                try {
                    const date = new Date(dateInput);
                    const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
                    const day = days[date.getDay()];
                    document.getElementById('dayOfWeek').value = day;
                    console.log('Set dayOfWeek to: ' + day);
                } catch (e) {
                    console.error('Error parsing date: ' + e.message);
                    document.getElementById('dayOfWeek').value = '';
                }
            } else {
                console.log('No date input, clearing dayOfWeek');
                document.getElementById('dayOfWeek').value = '';
            }
        }

        // Initialize Day of Week on page load
        document.addEventListener('DOMContentLoaded', () => {
            console.log('Page loaded, initializing dayOfWeek');
            updateDayOfWeek();
            console.log('Token value: ' + document.querySelector('input[name="token"]').value);
        });
        document.getElementById('date').addEventListener('change', () => {
            console.log('Date changed, updating dayOfWeek');
            updateDayOfWeek();
        });

        // Add new time slot
        function addSlot() {
            console.log('Adding new slot, current count: ' + slotCount);
            slotCount++;
            const slotsDiv = document.getElementById('slots');
            const newSlot = document.createElement('div');
            newSlot.className = 'slot-container';
            newSlot.id = `slot-${slotCount}`;
            newSlot.innerHTML = `
                <div class="row">
                    <div class="col-md-5">
                        <label for="startTime-${slotCount}" class="form-label">Start Time</label>
                        <input type="time" class="form-control" id="startTime-${slotCount}" name="startTimes" required>
                    </div>
                    <div class="col-md-5">
                        <label for="endTime-${slotCount}" class="form-label">End Time</label>
                        <input type="time" class="form-control" id="endTime-${slotCount}" name="endTimes" required>
                    </div>
                    <div class="col-md-2 d-flex align-items-end">
                        <button type="button" class="btn btn-danger w-100" onclick="removeSlot(${slotCount})" id="remove-${slotCount}">Remove</button>
                    </div>
                </div>
            `;
            slotsDiv.appendChild(newSlot);
            if (slotCount > 1) {
                document.getElementById('remove-1').style.display = 'block';
            }
            console.log('Added slot, new count: ' + slotCount);
        }

        // Remove time slot
        function removeSlot(slotId) {
            console.log('Removing slot: ' + slotId);
            const slot = document.getElementById(`slot-${slotId}`);
            if (slot) {
                slot.remove();
                slotCount--;
                if (slotCount === 1) {
                    document.getElementById('remove-1').style.display = 'none';
                }
                console.log('Removed slot, new count: ' + slotCount);
            } else {
                console.error('Slot not found: slot-' + slotId);
            }
        }

        // Log form submission
        function logSubmit() {
            console.log('Submitting form with token: ' + document.querySelector('input[name="token"]').value);
            console.log('Date: ' + document.getElementById('date').value);
            console.log('DayOfWeek: ' + document.getElementById('dayOfWeek').value);
            console.log('StartTimes: ' + Array.from(document.getElementsByName('startTimes')).map(input => input.value));
            console.log('EndTimes: ' + Array.from(document.getElementsByName('endTimes')).map(input => input.value));
        }
    </script>
</body>
</html>